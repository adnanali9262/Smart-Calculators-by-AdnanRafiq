<div class="calculator">
  <h2>ðŸ”Œ Telecom Rectifier Calculator</h2>

  <!-- Phase Selection -->
  <div class="form-grid" style="margin-top:8px">
    <div>
      <label for="phaseType"><b>Phase Type</b></label>
      <select id="phaseType" class="input">
        <option value="single">Single Phase</option>
        <option value="three">Three Phase</option>
      </select>
    </div>

    <div id="threeMode" style="display:none">
      <label for="threeType"><b>Three Phase Mode</b></label>
      <select id="threeType" class="input">
        <option value="balanced">Balanced Rectifier</option>
        <option value="unbalanced">Unbalanced Rectifier</option>
      </select>
    </div>
  </div>

  <!-- AC Inputs -->
  <div id="acInputs" class="form-grid" style="margin-top:8px">

    <!-- Single Phase -->
    <div id="singleInputs" style="display:block">
      <label>AC Input (Single Phase)</label>
      <input id="acV" class="input" type="number" placeholder="AC Voltage (V)">
      <input id="acI" class="input" type="number" placeholder="AC Current (A)">
      <input id="pf" class="input" type="number" step="0.01" placeholder="Power Factor">
    </div>

    <!-- Balanced Three Phase -->
    <div id="balancedInputs" style="display:none">
      <label>AC Input (Three Phase â€“ Balanced)</label>
      <input id="bV" class="input" type="number" placeholder="Line Voltage (V)">
      <input id="bI" class="input" type="number" placeholder="Line Current (A)">
      <input id="bPF" class="input" type="number" step="0.01" placeholder="Power Factor">
    </div>

    <!-- Unbalanced Three Phase -->
    <div id="unbalancedInputs" style="display:none">
      <label>AC Input (Three Phase â€“ Unbalanced)</label>
      <div><b>Phase 1:</b>
        <input id="v1" class="input" type="number" placeholder="Phase 1 Voltage (V)">
        <input id="i1" class="input" type="number" placeholder="Phase 1 Current (A)">
        <input id="pf1" class="input" type="number" step="0.01" placeholder="Phase 1 PF">
      </div>
      <div><b>Phase 2:</b>
        <input id="v2" class="input" type="number" placeholder="Phase 2 Voltage (V)">
        <input id="i2" class="input" type="number" placeholder="Phase 2 Current (A)">
        <input id="pf2" class="input" type="number" step="0.01" placeholder="Phase 2 PF">
      </div>
      <div><b>Phase 3:</b>
        <input id="v3" class="input" type="number" placeholder="Phase 3 Voltage (V)">
        <input id="i3" class="input" type="number" placeholder="Phase 3 Current (A)">
        <input id="pf3" class="input" type="number" step="0.01" placeholder="Phase 3 PF">
      </div>
    </div>

  </div>

  <!-- DC Output & Efficiency -->
  <div class="form-grid" style="margin-top:8px">
    <label>DC Output & Efficiency</label>
    <input id="dcV" class="input" type="number" placeholder="DC Output Voltage (V)">
    <input id="dcI" class="input" type="number" placeholder="DC Output Current (A)">
    <input id="eff" class="input" type="number" step="0.01" placeholder="Rectifier Efficiency (%)">
  </div>

  <!-- Controls -->
  <div class="controls" style="margin-top:12px">
    <button class="btn primary" id="calcBtn">Calculate</button>
    <button class="btn ghost" id="resetBtn">Reset</button>
  </div>

  <!-- Results -->
  <div id="result" class="result" style="display:none"></div>
</div>

<script>
(function(){
  const $ = id=>document.getElementById(id);
  const result = $("result");
  const allInputs = Array.from(document.querySelectorAll('input'));

  $("phaseType").onchange = updateUI;
  $("threeType").onchange = updateUI;
  $("calcBtn").onclick = calculate;
  $("resetBtn").onclick = resetAll;

  const paramNames = {
    acV: "AC Voltage (V)",
    acI: "AC Current (A)",
    pf: "Power Factor",
    bV: "Line Voltage (V)",
    bI: "Line Current (A)",
    bPF: "Power Factor",
    v1: "Phase 1 Voltage (V)",
    i1: "Phase 1 Current (A)",
    pf1: "Phase 1 PF",
    v2: "Phase 2 Voltage (V)",
    i2: "Phase 2 Current (A)",
    pf2: "Phase 2 PF",
    v3: "Phase 3 Voltage (V)",
    i3: "Phase 3 Current (A)",
    pf3: "Phase 3 PF",
    dcV: "DC Output Voltage (V)",
    dcI: "DC Output Current (A)",
    eff: "Rectifier Efficiency (%)"
  };

  function updateUI(){
    const phase = $("phaseType").value;
    $("threeMode").style.display = phase==="three"?"block":"none";
    $("singleInputs").style.display = phase==="single"?"block":"none";
    if(phase==="three"){
      const mode = $("threeType").value;
      $("balancedInputs").style.display = mode==="balanced"?"block":"none";
      $("unbalancedInputs").style.display = mode==="unbalanced"?"block":"none";
    }else{
      $("balancedInputs").style.display = "none";
      $("unbalancedInputs").style.display = "none";
    }
    clearHighlights();
  }

  function val(id){ return parseFloat($(id)?.value) || null; }
  function clearHighlights(){ allInputs.forEach(i=>i.style.border='1px solid #ccc'); }

  function detectMissing(){
    const phase = $("phaseType").value;
    const unbalanced = phase==="three" && $("threeType").value==="unbalanced";
    clearHighlights();

    let missing = null;
    if(unbalanced){
      missing = ["dcV","dcI","eff"].find(k=>val(k)===null);
      if(!missing){ error("Leave one DC output or efficiency empty"); return null; }
    } else {
      const mainKeys = phase==="single"?["acV","acI","pf","dcV","dcI","eff"]:["bV","bI","bPF","dcV","dcI","eff"];
      const missingList = mainKeys.filter(k=>val(k)===null);
      if(missingList.length!==1){ error("Fill exactly 5 parameters and leave one empty"); return null; }
      missing = missingList[0];
    }

    if(missing) $(missing).style.border = '2px solid orange';
    return missing;
  }

  function calculate(){
    const phase = $("phaseType").value;
    const missing = detectMissing();
    if(!missing) return;

    let PAC = null, PDC = null;

    const acV = val("acV"), acI=val("acI"), pf=val("pf");
    const bV = val("bV"), bI=val("bI"), bPF=val("bPF");
    const v1=val("v1"),i1=val("i1"),pf1=val("pf1"),
          v2=val("v2"),i2=val("i2"),pf2=val("pf2"),
          v3=val("v3"),i3=val("i3"),pf3=val("pf3");

    const dcV = val("dcV"), dcI = val("dcI"), eff = val("eff");

    // --- Compute AC Power ---
    if(phase==="single"){
      if(acV!==null && acI!==null && pf!==null) PAC = acV*acI*pf;
      else if(dcV!==null && dcI!==null && eff!==null) PAC = (dcV*dcI)/(eff/100);
    } else if(phase==="three"){
      const mode = $("threeType").value;
      if(mode==="balanced"){
        if(bV!==null && bI!==null && bPF!==null) PAC = Math.sqrt(3)*bV*bI*bPF;
        else if(dcV!==null && dcI!==null && eff!==null) PAC = (dcV*dcI)/(eff/100);
      } else PAC = v1*i1*pf1 + v2*i2*pf2 + v3*i3*pf3;
    }

    // --- Compute DC Power ---
    if(dcV!==null && dcI!==null) PDC = dcV*dcI;
    else if(dcV!==null && eff!==null && PAC!==null) PDC = PAC*eff/100;
    else if(dcI!==null && eff!==null && PAC!==null) PDC = PAC*eff/100;

    // --- Solve missing ---
    let resultValue = null;
    try{
      switch(missing){
        case "acV": resultValue = PAC/(acI*pf); break;
        case "acI": resultValue = PAC/(acV*pf); break;
        case "pf":  resultValue = PAC/(acV*acI); break;
        case "bV":  resultValue = PAC/(Math.sqrt(3)*bI*bPF); break;
        case "bI":  resultValue = PAC/(Math.sqrt(3)*bV*bPF); break;
        case "bPF": resultValue = PAC/(Math.sqrt(3)*bV*bI); break;
        case "dcV": resultValue = dcI!==null? PDC/dcI : null; break;
        case "dcI": resultValue = dcV!==null? PDC/dcV : null; break;
        case "eff": resultValue = PAC!==0? (PDC/PAC)*100 : null; break;
      }
    }catch(e){return error("Not enough input to calculate missing parameter");}

    // --- Display Result with Table ---
    result.style.display='block';
    result.innerHTML = `
      <div style="margin-bottom:8px;font-size:16px;color:orange;"><b>Missing Parameter:</b> ${paramNames[missing]} = <span style="color:#007bff">${resultValue!==null?resultValue.toFixed(3):'N/A'}</span></div>
      <table style="width:100%;border-collapse:collapse;font-size:14px">
        <tr style="background:#eee"><th style="border:1px solid #ccc;padding:4px">Parameter</th><th style="border:1px solid #ccc;padding:4px">Value</th></tr>
        <tr><td>AC Power (W)</td><td>${PAC!==null?PAC.toFixed(3):'N/A'}</td></tr>
        <tr><td>DC Power (W)</td><td>${PDC!==null?PDC.toFixed(3):'N/A'}</td></tr>
        <tr><td>Input Power (W)</td><td>${PAC!==null?PAC.toFixed(3):'N/A'}</td></tr>
        <tr><td>Output Power (W)</td><td>${PDC!==null?PDC.toFixed(3):'N/A'}</td></tr>
      </table>
    `;
  }

  function error(msg){ result.style.display='block'; result.innerHTML = `<span style="color:red">${msg}</span>`; }
  function resetAll(){ allInputs.forEach(i=>i.value=''); clearHighlights(); result.style.display='none'; result.innerHTML=''; }

  updateUI();
})();
</script>
