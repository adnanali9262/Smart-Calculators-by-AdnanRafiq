<div class="calculator">
  <h2>⚡ DC Cable Size</h2>

  <div class="form-grid" style="margin-top:8px">
    <div>
      <label for="dc_voltage">Source Voltage (V)</label>
      <input id="dc_voltage" class="input" type="number" step="any" placeholder="24">
    </div>

    <div>
      <label for="dc_current">Load Current (A)</label>
      <input id="dc_current" class="input" type="number" step="any" placeholder="10">
    </div>

    <div>
      <label for="dc_length">One-way Length (m)</label>
      <input id="dc_length" class="input" type="number" step="any" placeholder="30">
    </div>

    <div>
      <label for="dc_vdrop">Allowed Voltage Drop (%)</label>
      <input id="dc_vdrop" class="input" type="number" step="any" placeholder="3">
    </div>

    <div class="form-row">
      <label for="dc_material">Conductor</label>
      <select id="dc_material" class="input">
        <option value="copper" selected>Copper</option>
        <option value="aluminum">Aluminum</option>
      </select>
    </div>
  </div>

  <div class="controls" style="margin-top:12px">
    <button class="btn primary" id="dc_calc">Calculate</button>
    <button class="btn ghost" id="dc_reset">Reset</button>
  </div>

  <div id="dc_result" class="result" style="display:none"></div>
</div>

<script>
(function(){
  const $ = id => document.getElementById(id);
  const resultWrap = $('dc_result');
  const stdSizes = [0.5,0.75,1,1.5,2.5,4,6,10,16,25,35,50,70,95,120,150,185,240];

  function compute(){
    const V = parseFloat($('dc_voltage').value);
    const I = parseFloat($('dc_current').value);
    const L = parseFloat($('dc_length').value);
    const pct = parseFloat($('dc_vdrop').value);
    const mat = $('dc_material').value;
    if (!V || !I || !L || !pct) {
      resultWrap.style.display='block';
      resultWrap.innerHTML = '<div class="small" style="color:#c00"><strong>Fill all fields with positive numbers.</strong></div>';
      return;
    }
    const VdropAllowed = V * (pct/100);
    const effLength = L * 2; // round-trip
    const rho = mat === 'aluminum' ? 0.0282 : 0.01724; // Ω·mm²/m
    const A = (rho * I * effLength) / VdropAllowed;
    const A_rounded = Math.ceil(A*10)/10;
    const recommended = stdSizes.find(s => s >= A_rounded) || stdSizes[stdSizes.length-1];
    const Rrec = (rho * effLength) / recommended;
    const VdropRec = I * Rrec;
    const dropPctRec = (VdropRec / V) * 100;

    resultWrap.style.display='block';
    resultWrap.innerHTML = `
      <h4>Results</h4>
      <div class="small">Required (theoretical): <span class="code">${A.toFixed(3)} mm²</span></div>
      <div style="margin-top:8px"><strong>Recommended standard size:</strong> <span style="color:green;font-size:18px">${recommended} mm²</span></div>

      <div style="margin-top:12px">
        <strong>Estimated voltage drop with ${recommended} mm²:</strong>
        <div class="small">Drop = ${VdropRec.toFixed(3)} V (${dropPctRec.toFixed(3)}%)</div>
      </div>

      <details style="margin-top:12px">
        <summary>Calculation breakdown</summary>
        <pre class="small" style="white-space:pre-wrap;margin-top:8px">
Inputs:
  V = ${V} V
  I = ${I} A
  One-way length = ${L} m (round-trip = ${effLength} m)
  Allowed drop = ${pct}% => ${VdropAllowed.toFixed(4)} V
Material rho = ${rho} Ω·mm²/m

Formulas:
  A_required = rho * effLength / (VdropAllowed / I)
  A_required = ${A.toFixed(6)} mm²
Recommended = ${recommended} mm²

R_rec = rho * effLength / A_rec = ${Rrec.toExponential(6)} Ω
V_drop_rec = I * R_rec = ${VdropRec.toFixed(6)} V
        </pre>
      </details>
    `;
  }

  function reset(){
    $('dc_voltage').value='24';
    $('dc_current').value='10';
    $('dc_length').value='30';
    $('dc_vdrop').value='3';
    $('dc_material').value='copper';
    resultWrap.style.display='none';
    resultWrap.innerHTML='';
  }

  document.addEventListener('click', function onDoc(e){
    // ensure handlers exist after dynamic insertion
    if ($('dc_calc')) {
      $('dc_calc').addEventListener('click', compute);
      $('dc_reset').addEventListener('click', reset);
      document.removeEventListener('click', onDoc);
    }
  });

  // fallback: set defaults now if inputs exist
  setTimeout(()=>{ if($('dc_voltage')) reset(); }, 50);
})();
</script>
